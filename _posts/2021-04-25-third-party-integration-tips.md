---
layout: post
title: "程序员少掉发之--第三方集成注意事项"
description: ""
category: 
tags: []
---
{% include JB/setup %}
## 对未知的恐惧

<div style="text-align:center"><img src ="/assets/images/fear.jpeg" style="height:200px;" /></div>

项目团队中时不时地会听到团队成员对需要集成地第三方系统的抱怨：
> “XXX团队这个功能还没做，我这张卡没法测了”

> “他们这个API怎么又报错了”

> “他们又不通知我们改了API导致了这个问题”

> “这个功能XXX不支持，我们没法做。。”

> “XXX功能又坏了，导致我们showcase流程没走通。。”

这样的抱怨多了，经验或上下文稍微少一点的同事一看到需要和这个第三方集成的卡，如闻虎色变，不敢去拿，甚至都不太敢去了解更多。第三方的妖魔化这样就一点点默默形成了。。

这样的现象并不是个例，毕竟第三方无论从最初设计还是后续变化上对本项目的成员来说都是未知居多。人类对于未知的恐惧是与生俱来的。然而，就像上图中，人们看到的通常并不是物体的全貌，而是通过各个渠道得到的信息组成的一个投影。

## 不可避免的集成


<div style="text-align:center"><img src ="/assets/images/walk-around.jpeg" style="height:200px;" /></div>
然而，这样的集成几乎对每个项目来说都是不可避免的。
一来，各种服务满天飞的今天，加上程序员们的“懒”促使层出不穷的可复用的轮子，投资方也更愿意节省时间金钱使用这些轮子，几乎每一个系统都不可避免地需要集成其他服务。例如，集成成熟的商业化支付服务，单点登陆系统等。

二来，一个大的系统多数情况下是多个vendor，多个团队协作完成的，一个大团队也会拆分为多个小团队。与其他团队正在开发的或已上线的服务集成也就必不可少。

## 如何保证集成顺滑

-- 上线当天发现第三方不可用的血泪史


既然与第三方集成不可避免，如何才能让集成工作更加顺利，尽量不出现突然发生紧急事故的状态发生呢？

我们可以从两种第三方系统来看，已成熟的线上服务和正在开发的服务。


### 集成成熟已上线服务

<div style="text-align:center"><img src ="/assets/images/on-live-system.png" style="height:150px;" /></div>
如果集成的是已上线且版本基本稳定的服务，相对处理起来容易一些。常见的此类第三方系统有auth系统，payment系统。

#### 理解此第三方的职责范围，架构和infra，及如何使用
作为使用方，最初需要明确知道集成的每个第三方主要提供的服务界限，才能在设计自己系统时明确需要覆盖的功能范围。

可以从两个视角来看：功能和数据。
- 功能上，这个第三方系统提供什么样的服务？比如，auth系统提供注册，登录，权限管理等服务。
- 数据上，这个第三方系统主要管理什么数据，哪些数据是以第三方系统为准，哪些数据是辅助数据，数据流是什么样的。比如，auth系统，注册时得到的用户名，密码，profile信息，权限管理数据都是auth系统收集的，并以auth系统为准。如果我们作为消费方需要读取用户的profile信息，应从auth系统拿，无论是实时拿还是通过batch或者cache，而不应自行存储另一套，导致数据不统一造成之后一系列问题。如果消费方需要存储一份，则需要同步回auth系统。
	
通常第三方服务的服务范围都很难了解的十分清楚，特别是细节。而设计却需要短时间内完成，对第三方架构的理解就有所帮助。如，某auth系统分为SP, OP, OOB三个服务, 分别负责XXX功能，这几个服务的功能叠加就是此系统的职责范围。此类成熟系统的架构信息通常有文档记录，这些文档可能是值得挖掘的宝藏。
	
如何使用此服务部分，很需要一个和服务相符的最新文档，如果是提供的restful API服务，尽量收集API的文档，比如swagger文档对后续开发阶段就很重要。

#### 需要提前准备的测试环境与线上环境

“工作的代码高于详尽的文档”。所以，我们需要第三方提供供调试的测试环境，保证服务功能正常工作。理想情况下自然是我们的系统需要的每一个环境对应一个第三方的不同环境，标配的dev，qa，uat和prod各自对应一个第三方环境。

但很多情况下，第三方服务只提供一个测试环境（类生产环境），我们系统的dev, qa, uat公用一个测试环境。这样就会导致不同环境间数据上的互相影响，如第三方是登陆系统，高环境创建的账号就会受低环境上的配置改变影响，可能导致PO signoff和showcase等重要时刻的发生事故。其他环境公用资源的影响众多，不再赘述。

> 在这种第三方确实“没有办法”提供更多测试环境的情况下，生成一个假的第三方就不得不做，比如Singpass对应的Mockpass，用契约文件生成的API服务（moco）。

> 当然，如果第三方是很复杂的系统，无法fake一个相同功能的系统时，只有尝试尽力争取更多测试环境
- 比如，遇到付费服务需要绑定真实银行卡之类的第三方服务，就相对比较麻烦，据说某一个项目上线最痛的点就是第三方不提供任何测试环境，功能可不可用，上线了才知道，这就只能白了少年头，想其他办法了。比如持续不断地和第三方及其上级沟通（掰扯），让他们提供测试环境。
- 若既无法mock被集成服务，又无法申请更多测试环境，只能防守，让整个团队aware第三方环境使用情况，以及可能导致的后果。比如，测试人员在QA环境做了一些改变后，可能会收到第三方系统发来的关于此次操作的多封通知邮件。

#### 第三方maintenance对我们的影响
稳定的第三方可能会定期或时不时地做维护，这种计划好的downtime，就只有通过提早计划和通知，及时沟通解决了。maintenance的时间避开重要的时间段，如showcase，上线等。也适用于第三方不向下兼容的升级，或配置文件改变等情况。


### 集成正在开发中服务


<div style="text-align:center"><img src ="/assets/images/in-progress-system.jpeg" style="height:200px;" /></div>
如果是和正在开发，甚至刚开始设计的第三方系统集成，就需要花更多的精力了，甚至需要帮助他们从设计到实施，到持续集成和发布，有时还要帮助他们做计划。也许这就是作为解决客户问题的咨询公司而非外包公司的价值体现吧。（虽然很累地做了职责范围外的事情。）

#### 设计上


<div style="text-align:center"><img src ="/assets/images/design.png" style="height:200px;" /></div>
设计上，先从职责定位先定大方向，第三方系统主要提供什么样的服务。比如，最近项目集成的第三方主要负责预定服务，无论预定的是什么资源。

仍然从业务能力和数据两方面看此系统。
> 业务能力上，自然是提供对预定的增删查改服务，以及对应的资源建立，对资源操作的权限控制部分。

> 数据上，因为定位是通用的预定服务，包含业务场景的特殊资源信息就无法也不应该由此三方系统拥有和管理。只应由我们的系统host这些信息，并在需要传输给第三方展示，或作为表示的时候传给第三方即可。相似的，我们负责的系统不应存储任何预定相关的信息，每次使用预定信息时都需要向第三方
请求，以第三方系统的预定数据为source of truth。如有从我们的系统中修改预定信息的需求，也只能通过第三方提供的接口完成，或通过数据同步完成。

设计到实施衔接阶段需要细化到API design级别（此级别的设计可能在同时开发过程中持续完成）。
- 包含身份认证方式，以用户登录系统的SSO来认证，还是我方服务器与他方服务器之间建立信任关系，服务器之间建立了信任关系后，能够通信的资源级别是什么，所有资源有权限通信，还是分块资源可通信。
- 包含happy path的对我方输入信息是什么，输出信息是什么，和sad path的status确定。
- 还有一个最主要的，用哪些字段唯一标识某一个资源，整个user flow中这样的信息流转先后顺序是否符合逻辑，每个信息交换节点是否有必要的信息输入来源。

拉通好什么样的改动是breaking change，什么样的改动是可以不影响集成功能的可接受的change也是至关重要。团队经常发现第三方时不时地不通知就修改了API，导致功能不可用。这时，并不一定要第一时间blame第三方又有改动，毕竟任何一个系统或服务的功能都是在不断演进的，而需要检查是否是影响相应功能的改动，如果是breaking change，比如API request的必填字段多了，则确实要问责使其修改，但如果只是API response里多了几个optional的字段导致我方功能问题，就是我方代码不健壮的体现了。对于API的breaking change，这篇文章说得很详细：https://bambielli.com/til/2018-01-12-what-is-a-breaking-change/。

拉通在设计上的信息虽然可能花很多时间（比如我们最近项目最初稿用了大约一个月，后面持续进行），但是一定要不厌其烦地拉通，并留下拉通后的结果，一是作为之后落地实现时的参考，二来也是作为后续有集成问题时的权责方佐证。

#### 实现上


<div style="text-align:center"><img src ="/assets/images/implementation.jpeg" style="height:200px;" /></div>
当设计框架基本完成，开始落地细节时，按理应该比较顺利，但仍然可能出现功能“时间差”。我方期望在某个时间节点完成的功能不能按时完成，导致无法按计划正常集成测试，从而无法真正将一系列相关的任务卡挪到完成列。

##### 时间线
此时就需要计划并沟通好的时间线，大概在什么时间点完成什么样的大功能，并定时check。有人会说我们是敏捷啊，要拥抱变化，但是敏捷并不代表毫无计划。因为开发先后顺序和没有target时间的问题导致互相block工作，也不是敏捷期望看到的结果。

##### 实时沟通
除了定时沟通各自的进度之外，还需要一个实时沟通的渠道，实施阶段会出现各种各样的问题，准备数据的，环境挂掉的，功能不完整的，客户不满意的，都需要实时找到对方对应的人，及时解决。事实证明，“个体和互动高于流程和工具”是真理，流程也是很重要的，仪式感可以带来压力和严肃感，提高“履约”效率；与之相符的个体和互动对日常解决问题至关重要，找到正确的人，得到及时的回复是减少第三方集成带来痛苦的关键。

##### 关键时间点
除此之外，关键时间节点的严肃认真沟通确认也是必不可少的一环，可以大幅度减少抓头发时长。比如，各个老板会齐的showcase，需要和第三方确认沟通好在此时间段要保持对应环境的稳定 -- 不要部署新代码，不要宕机维护，不要修改配置文件，不要修改对应的测试数据等等。

上线计划也需要提前沟通好，包含上线时间点，对应上线需要第三方完成和稳定的功能，需要初始化的数据，需要上线前完成各种测试的范围和时间，等等。遇上专业的第三方团队，明确完时间线和需要的支持后就可以放心了，但也无法避免测试覆盖率不高（不靠谱）的第三方团队。所以，将要上线的前至少一两周要持续关注第三方系统的状态，若发现问题，及时提出并作为高优先级使其修复。

##### 惊喜（吓）
万事具备，但可能还是会有“惊喜”。上线前一天确认第三方集成点都是正常工作的，但上线同样的功能当天不工作的情况也时有发生。此时可能会怀疑人生，但充足的log可以帮我们很快就找到问题所在，并及时通知事先要求standby的第三方定位修复问题。这个过程虽然对导致团队气氛下降，但也足以在客户面前证明我们的专业，塞翁失马，焉知非福。

##### 合作关系--萝卜大棒并行 
最后，虽然和第三方团队协作过程中可能出现一系列磕磕绊绊，但认准他们团队中谁负责哪一部分，能力如何，当发生小问题时，礼貌指导性地通知修复，发生严重问题时，严肃而不失礼貌地陈述事实和影响，偶尔表扬一下给颗糖，还是会戏剧性地让合作变得越来越顺畅。所谓“做人留一线，日后好相见”，这也是为什么团队对第三方抱怨重重时，我仍然保持不生气理智沟通的态度的原因。不过话说偶尔让他们的管理方知道他们层出不穷的问题也可以起到很好的作用。用非技术手段解决技术问题，在第三方集成（管理）上多有体现。

## 后话

想到之前pre-sale时了解到客户对技术方面的唯一要求是需要有和大量第三方集成的经验，各种服务爆炸的现在，不仅能顺滑的被依赖是这些服务是否成功的标准之一，而且能顺利地使用和集成已有服务也是对程序员和软件公司能力的考验标准。

你有何第三方集成时的妙招和或血泪教训吗？说来听听吧~
